<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="./assets/style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="shortcut icon" href="./assets/img/favicon.png">
    <link rel="apple-touch-icon" href="./assets/img/noround.png">
    <title>WebDesk</title>
</head>
<script>
    var deskid;
    var setupd;
</script>

<body>
    <div id="background"></div>
    <div class="circle"></div>
    <div class="circle2"></div>
    <div id="setuparea">
    </div>
    <div id="fucked">
        <div class="center">
            <img src="./assets/img/favicon.png" style="width: 140px; height: 140px;"></img>
            <p style="color: #fff; margin-top: 12px;" class="bold">Please wait</p>
            <p style="color: #fff; margin-top: 4px;">Stage 1/4: Backup</p>
        </div>
    </div>
    <div id="notif"></div>
</body>

</html>
<script src="./assets/code/vals.js"></script>
<script src="./assets/lib/jq.js"></script>
<script src="./assets/lib/jszip.js"></script>
<script src="./assets/lib/peer.js"></script>
<script src="./assets/code/core.js"></script>
<script src="./assets/code/wm.js"></script>
<script src="./assets/code/services.js"></script>
<script src="./assets/code/ui.js"></script>
<script src="./assets/code/fs.js"></script>
<script src="./assets/code/apps.js"></script>
<script>
    async function boot() {
        const sd = await fs.read('/system/check');
        if (sd) {
            const name = await fs.read('/user/info/name');
            const deskid = await fs.read('/system/deskid');
            await wd.desktop(name, deskid);
            await ptp.go(deskid);
            setupd = true;
        } else {
            const id = gen(8);
            await ptp.go(id);
            await fs.write('/system/deskid', id);
            app.setup();
            setupd = false;
        }

        const dropZone = document.body;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            let dt = e.dataTransfer;
            let files = dt.files;

            handleFiles(files);
        }

        async function handleFiles(files) {
            let filesArray = [...files];
            filesArray.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const contents = e.target.result;
                    fs.write(`/user/files/${file.name}`, contents);
                };

                if (file.type.startsWith('image')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }
    }
</script>